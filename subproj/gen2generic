
import groovy.json.JsonBuilder
import groovy.json.JsonSlurper


// Globals
def mvnHome = "/opt/apache-maven-3.2.5"
def build_version
def sha1


def repo="sdf"

def service_git_url='https://github.com/WPPg2/avatar-reg.git'
def service_git_credentialsId='7a9d9c98-fec1-4a3c-82ff-53295d9d5c9b'
def service_pom_version_tag='avreg.version'
def service_name="avreg"
def service_version="1.0.13"
def service_cookbook_version="1.0.13"
def service_deploy_input_files_folder="/home/kookalko/pipeline/services/avreg"



def cd_git_url='https://github.com/WPPg2/DevOps-Deployment.git'
def cd_git_credentialsId='7a9d9c98-fec1-4a3c-82ff-53295d9d5c9b'
def commit_id="cmtid"



stage 'Check'
echo "Stage check"


//Properties props = new Properties()
//File propsFile = new File('/tmp/var.groovy')
//props.load(propsFile.newDataInputStream())
//println props.getProperty('vara')






parallel(firstTask: {
     node('CTF') {
       // Do some stuff]
       echo "First parallel task"
    }
}, secondTask: {
    node('AMIBuilder') {
        // Do some other stuff
        echo "Second parallel task"
    }
})
   
   
stage 'Build'
   node('CTF') {
   
       def mb = new com.hp.wpp.cd.pipelines.mavenBuild()
       service_version = mb.checkOut("$service_git_credentialsId","$service_git_url","$service_pom_version_tag")
       echo "$service_version"
    
       //mb.mvnBuild("${mvnHome}/bin/mvn","$build_version")
       echo "Build Stage"
   }

stage 'Deploy'
   copy_files_to_node('CTF',service_deploy_input_files_folder)
   deploy_service('AMIBuilder',service_deploy_input_files_folder)
   

def deploy_service(slave,files_folder) {
   // new File("${workspace}/cd_deploy_input.json").write(cd_deploy_input_json)
   
/*
   print "$cd_deploy_input_json"
   sh "echo $cd_deploy_input_json > ${workspace}/deploy_input.json"
   sh "cat ${workspace}/deploy_input.json"
   

   sh "sudo chef-client -z -j /home/ec2-user/avreg/deploy_avreg.json -r 'recipe[ec2::deployService]' --log_level info"

   sh "cat /home/ec2-user/avreg.log.ipaddr" */

}

def copy_files_to_node(node_name,folder)  {
     
     def basedir = new File(folder)


     files = basedir.listFiles()

     for (currentFile in files) { 
          println "  Copying $currentFile"                

          //File f = new File(currentFile)
          def jsonText = currentFile.getText()

          def slurper = new JsonSlurper()
          slurped = slurper.parseText( jsonText )
          slurped.service.artifact_url="sdfskkkkddddd"
          def builder = new JsonBuilder(slurped)

          def output = builder.toPrettyString()
   
          print output
          
          slurper = null
          slurped=null
          builder = null
          f=null
          g=null
          currentFile=null
   
          node(node_name) {
               writeFile file: '/tmp/test.json', text: output
      
          }

     }
     basedir=null
     files=null
}




